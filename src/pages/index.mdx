import { useEffect, useState, useContext } from 'react';
import { Link, graphql } from 'gatsby'

import Layout from '../components/layout'
import Toolbar from '../components/Toolbar'
import FilmItem from '../components/FilmItem'
import Image from '../components/image'
import SEO from '../components/seo'
import PageLoader from '../components/PageLoader';
import { FilmsWrapper } from './../components/styled';
import { MovieContext } from './../store'
import { UPDATE_STREAMING_PROVIDERS } from './../store/types';
import { streamingProviders } from './../helper/constants';

export const query = graphql`
	query allFilmsQuery {
		allFilmsJson {
			edges {
				node {
					movieId
					jwId
					movieName
					movieYear
					moviePoster
					movieRating
					movieDescription
					dayWatched
					dateWatched
				}
			}
		}
	}
`
async function fetchStreamingProviders() {
	try {
		const response = await fetch('https://apis.justwatch.com/content/providers/locale/en_IN');
		const responseData = await response.json();
		return responseData;
	} catch (error) {
		throw error;
	}
}

export default function Index ({ data: { allFilmsJson: { edges: filmEdges }} }) {
	// console.log(filmEdges);
	const [loading, setLoading] = useState(true);
	const { dispatch } = useContext(MovieContext);
	useEffect(() => {
		(async () => {
			const config = window.localStorage.getItem("config");
			let loadTime = 3000;
			if(config) {
				const parsedConfig = JSON.parse(config);
				if(parsedConfig.loaded) {
					loadTime = 300;
				}
			}
			setTimeout(() => {
				setLoading(false);
			}, loadTime);
			window.localStorage.setItem("config", JSON.stringify({ loaded: true } ));
			const stramingProviders = await fetchStreamingProviders();
			const parseStreamingProviders = {};
			stramingProviders.forEach((provdr) => parseStreamingProviders[provdr.id] = { name: provdr.clear_name, key: provdr.technical_name, logo: streamingProviders[provdr.technical_name] || "" })
			await dispatch({ type: UPDATE_STREAMING_PROVIDERS, payload: parseStreamingProviders });
		})();
	}, []);
	return loading ?
	(
		<PageLoader />
	) :
	(
		<Layout>
			<SEO title="Home" keywords={['gatsby', 'application', 'react']} />
			<Toolbar />
			<FilmsWrapper>
				{ filmEdges.map(filmNode => 
					<FilmItem 
						key={filmNode["node"].movieId}
						movieId={filmNode["node"].movieId}
						moviePoster={filmNode["node"].moviePoster}
						movieName={filmNode["node"].movieName}
						movieYear={filmNode["node"].movieYear}
						movieRating={filmNode["node"].movieRating}
						dayWatched={filmNode["node"].dayWatched}
						dateWatched={filmNode["node"].dateWatched}
						movieDescription={filmNode["node"].movieDescription}
						jwId={filmNode["node"].jwId}
					/>)
				}
			</FilmsWrapper>
		</Layout>
	)
}